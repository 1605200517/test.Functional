#  Aeron IoT Broker:  functional test guidelines #

* [Introduction](#introduction)
* [Testing environment](#testing-environment)
* [Overall preliminary setup](#overall-preliminary-setup)
* [Testing step by step](#testing-step-by-step)


## Introduction ##
Aeron is the FIWARE GE reference implementation of the IoT Broker Generic Enabler by NEC available at its [GitHub repository](https://github.com/Aeronbroker/Aeron).

## Testing environment ##
The testing environment can be easily set up through a FIWARE Lab, which is based on the cloud operating system OpenStack, and through which it is easy to create and configure a number of machines with the HW [requirements](http://fiware-iot-broker.readthedocs.io/en/latest/installadminguide/index.html#minimum-system-requirements)  needed by the GEri installation. Alternatively a different virtualisation system can be adopted as well as to prepare the overall hardware required, namely all the phisical/virtual machines needed for the test, which are:

1. A machine for the deployment of the GEri to be tested, ** IoT Broker** server. Since this GEri, in order to work properly, rely on the GE **IoTDiscovery**, a mockup implementation of the latter - available from the same owner- will be installed on the same machine.
2. A machine for **JMeter**, the tool used to invoke all the **IoTBroker APIs** and for simulating the client and collecting the results generated by Aeron IoT Broker.
3. A machine for a server where to host a custom mock-up (WS application) named **iot-broker-tester** developed to simulate the missing actors needed by some test scenarios. It may be same of that one at point 1.


## Overall preliminary setup ##

Once the HW necessary for the test described previosly at "Testing Environmment" chapter has been setup, the following preliminary steps need to be accomplished before to start the test process:

### 1. Docker installation: ###
Docker is a prerequisite for having this version (5.4.3) up&running in the easiest and simplest way; it can be installed following the instructions at:
https://docs.docker.com/engine/installation/linux/ubuntu/#install-using-the-repository

### 2. IoTBroker + IoTDiscovery installation & execution: ###
The following command line execution will download, install and run version 5.4.3 of IoTBroker GEri together with  the aforementioned dependency which is ConfMan, a lightweight implementation for test purpose of the IoTDiscovery, developed by the same owner of IoTBroker.

	sudo docker run -t -p 8065:8065 -p 8060:8060 -p 5984:5984 fiware/iotbroker:v5.4.3-standalone -p iotbroker_semantic="disabled" -p iotbroker_producedtype="application/xml"  &

### 3. JMeter installation: ###
 **Download** [JMeter 3.1](https://jmeter.apache.org/download_jmeter.cgi) and install it into the JMeter dedicated server.

### 4. *iot-broker-tester* installation & execution: ###

***iot-broker-tester*** component is essential for testing the QueryContext API whereas a data provider is needed in order to have the entire loop working properly; in fact this component plays the role of Data Provider -of which the component IoTDiscovery must be made aware through a registerContext NGSI9 operation already set within the JMeter test plan- which is able to simulate a number of agents (one agent is enough for functional testing, more than one can be used in the non functional ones) that will answer with dummy data (but contextual to each request) once invoked by the IoTBroker.

1. **Download** the iot-broker-tester component from the [GitHub repository](https://github.com/Fiware/test.NonFunctional/tree/master/testers/aeron/fiware-iotbroker-tester).
2. **Compile** the code of this component through the command `mvn package` (Maven and Java must have been previously installed). An uber-JAR (jar with all dependencies) named `iotbroker-tester-x.x.x.jar`  (where x.x.x is the current version) will be created in the sub-folder `target`.
3. **Copy** the jar file `iotbroker-tester-x.x.x.jar` created at the previous step to any folder of the dedicated server for this component.
4. **Run** the java application iotbroker-tester with the command:

		java â€“jar iotbroker-tester-x.x.x.jar data-provider 1

it will open one [1] port (8071) listening for queryContext invocations.


## Testing step by step ##

1. **Download** the JMeter plan file [`[IoTBroker-5.4.3.jmx]`](IoTBroker-5.4.3.jmx]) and the NGSI  [`[NGSI]`](./NGS])  folder with all its xsd files. 
2. **Edit**  the JMeter plan file with JMeter application or any text editor and change the value of the **`HOST` parameter** with the current address of IoTBroker server.
2. **Place** the JMeter plan file with the NGSI folder in any folder of the **JMeter server** henceforth referenced as `<jmeter-plan-path>`.
3. Open a shell on JMeter server and **start the test** using the command `<jmeter-path>/jmeter.sh -n -t <jmeter-plan-path>/IoTBroker-5.4.3.jmx`
4. **Retrieve the results** of JMeter session test once it has ended. They are colleceted in a csv file which is placed in  and named as following: `Aeron-IoTBroker-5.4.3_yyyy-MM-ddHHmmss.csv`
